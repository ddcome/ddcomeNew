<!DOCTYPE html>
<html>
    <head>
		<meta charset="UTF-8">
		<title>PDF文件发布</title>
        <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <!-- favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

        <!-- bootstrap framework -->
		<link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
		
        <!-- icon sets -->
            <!-- elegant icons -->
                <link href="assets/icons/elegant/style.css" rel="stylesheet" media="screen">
            <!-- elusive icons -->
                <link href="assets/icons/elusive/css/elusive-webfont.css" rel="stylesheet" media="screen">
            <!-- flags -->
                <link rel="stylesheet" href="assets/icons/flags/flags.css">
            <!-- scrollbar -->
                <link rel="stylesheet" href="assets/lib/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css">


        <!-- google webfonts -->
		<link href='http://fonts.googleapis.com/css?family=Open+Sans&amp;subset=latin,latin-ext' rel='stylesheet' type='text/css'>

        <!-- main stylesheet -->
		<link href="assets/css/main.min.css" rel="stylesheet" media="screen" id="mainCss">

        

        <!-- moment.js (date library) -->
        <script src="assets/js/moment-with-langs.min.js"></script>

    </head>
    <body class="side_menu_active side_menu_expanded">
        <div id="page_wrapper">

            <!-- header -->
            <header id="main_header">
            </header>

            <!-- breadcrumbs -->
            <nav id="breadcrumbs">
                <ul>
                    <li><a href="dashboard.html">首页</a></li><li><span>PDF文件发布</span></li><li><span>发布</span></li>
                </ul>
            </nav>

            <!-- main content -->
            <div id="main_wrapper">
                <div class="container-fluid">
                    <fieldset>
                        <legend><span>发布内容</span></legend>
                    </fieldset>
                    <div class="row">
                        <div class="col-lg-6">
                        
                            <label for="reg_input">上传至服务器路径:</label>
                            <input type="text" id="serverUrl" name="serverUrl" value="G:/UPLOADS" class="form-control">
                            <br/>
                            <input type="file" name="fileToUpload" id="fileToUpload"/>
                            <!-- multiple="multiple" -->
                        </div>
                    </div>
                    <div class="row">
                        
	                    <div class="col-lg-3">
	                     <label>选择标签:</label>
	                    	<input type="text" id="association" name="association" class="form-control" placeholder="请搜索关键词...">
	                    	<div id="association-div" style="width:100%; border:1px solid #ccc;height:100px;overflow:auto;display:none;">
	                    	</div>
	                    </div>
	                    <div class="col-lg-3">
	                    	<label>选中的标签：</label><br>
		                	<ul id="select_tags" style="list-style-type:none;padding-left:3px;">
		                	</ul>
	                    </div>
                       
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <button class="btn" type="button" id="upload" onclick="upload()">上&nbsp;&nbsp;传</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- main menu -->
            <nav id="main_menu">
                <div class="menu_wrapper">
                    <ul>
                        <li class="first_level">
                            <a href="index.html">
                                <span class="icon_house_alt first_level_icon"></span>
                                <span class="menu-title">首页</span>
                            </a>
                        </li>
                        <li class="first_level">
                            <a href="javascript:void(0)">
                                <span class="icon_group first_level_icon"></span>
                                <span class="menu-title">用户管理</span>
                            </a>
                            <ul>
                                <li><a href="manager_all.html">系统管理员</a></li>
                                <li><a href="manager_configuration.html">当前用户设置</a></li>
                                <li><a href="user_all.html">用户管理</a></li>
                            </ul>
                        </li>
                        <li class="first_level">
                            <a href="javascript:void(0)">
                                <span class="icon_pencil_alt first_level_icon"></span>
                                <span class="menu-title">内容管理</span>
                            </a>
                            <ul>
                                <li class="submenu-title">Pages</li>
                                <li><a href="content_add.html">新增内容</a></li>
                                <li><a href="content_list.html">内容列表</a></li>
                            </ul>
                        </li>
                        <li class="first_level">
                            <a href="javascript:void(0)">
                                <span class="icon_pens_alt first_level_icon"></span>
                                <span class="menu-title">MarkDown笔记管理</span>
                            </a>
                            <ul>
                                <li class="submenu-title">Pages</li>
                                <li><a href="markdown_add.html">新增MarkDown笔记</a></li>
                                <li><a href="markdown_list.html">MarkDown笔记列表</a></li>
                            </ul>
                        </li>
                        <li class="first_level">
                            <a href="javascript:void(0)">
                                <span class="icon_document first_level_icon"></span>
                                <span class="menu-title">PDF文件发布</span>
                            </a>
                            <ul>
                                <li class="submenu-title">Components</li>
                                <li><a class="act_nav" href="upload_pdf.html">发布</a></li>
                                <li><a href="pdfile_list.html">PDF文件列表</a></li>
                            </ul>
                        </li>
                        <li class="first_level">
                            <a href="javascript:void(0)">
                                <span class="icon_comment first_level_icon"></span>
                                <span class="menu-title">评论管理</span>
                                <span class="label label-danger">6</span>
                            </a>
                            <ul>
                                <li class="submenu-title">Plugins</li>
                                <li><a href="comment_unchecked.html">回复评论(6)</a></li>
                                <li><a href="comment_list.html">所有评论</a></li>
                            </ul>
                        </li>
                        <li class="first_level">
                            <a href="javascript:void(0)">
                                <span class="icon_tools first_level_icon"></span>
                                <span class="menu-title">其他设置</span>
                            </a>
                            <ul>
                                <li class="submenu-title">Plugins</li>
                                <li><a href="author_setting.html">关于作者</a></li>
                                <li><a href="people_test.html">公测设置</a></li>
                                <li><a href="books_list.html">读书管理</a></li>
								<li><a href="words_list.html">语录管理</a></li>
                            </ul>
                        </li>
                        <li class="first_level has_submenu">
                            <a href="javascript:void(0)">
                                <span class="first_level_icon icon_menu-circle_alt2"></span>
                                <span class="menu-title">扩展</span>
                            </a>
                            <ul>
                                <li class="submenu-title">Sub menu</li>
                                <li><a href="javascript:void(0)">01. Lorem ipsum</a></li>
                                <li class="has_submenu">
                                    <a href="javascript:void(0)">02. Lorem ipsum</a>
                                   <ul>
                                        <li class="has_submenu">
                                            <a href="javascript:void(0)">02.1 Lorem ipsum dolor sit amet</a>
                                            <ul>
                                                <li><a href="javascript:void(0)">02.1.1 Lorem ipsum</a></li>
                                                <li><a href="javascript:void(0)">02.1.2 Lorem ipsum</a></li>
                                                <li><a href="javascript:void(0)">02.1.3 Lorem ipsum</a></li>
                                                <li><a href="javascript:void(0)">02.1.4 Lorem ipsum</a></li>
                                            </ul>
                                        </li>
                                        <li><a href="javascript:void(0)">02.2 Lorem ipsum</a></li>
                                        <li><a href="javascript:void(0)">02.3 Lorem ipsum</a></li>
                                        <li><a href="javascript:void(0)">02.4 Lorem ipsum</a></li>
                                    </ul>
                                </li>
                                <li class="has_submenu">
                                    <a href="javascript:void(0)">03. Lorem ipsum</a>
                                    <ul>
                                        <li><a href="javascript:void(0)">03.1 Lorem ipsum</a></li>
                                        <li><a href="javascript:void(0)">03.2 Lorem ipsum</a></li>
                                        <li><a href="javascript:void(0)">03.3 Lorem ipsum</a></li>
                                        <li><a href="javascript:void(0)">03.4 Lorem ipsum</a></li>
                                    </ul>
                                </li>
                                <li><a href="javascript:void(0)">04. Lorem ipsum</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="menu_toggle">
                    <span class="icon_menu_toggle">
                        <i class="arrow_carrot-2left toggle_left"></i>
                        <i class="arrow_carrot-2right toggle_right" style="display:none"></i>
                    </span>
                </div>
            </nav>

        </div>

        <!-- jQuery -->
        <script src="assets/js/jquery.min.js"></script>
        
        <!-- jQuery Cookie -->
        <script src="assets/js/jqueryCookie.min.js"></script>
        <!-- Bootstrap Framework -->
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <!-- retina images -->
        <script src="assets/js/retina.min.js"></script>
        <!-- switchery -->
        <script src="assets/lib/switchery/dist/switchery.min.js"></script>
        <!-- typeahead -->
        <script src="assets/lib/typeahead/typeahead.bundle.min.js"></script>
        <!-- fastclick -->
        <script src="assets/js/fastclick.min.js"></script>
        <!-- match height -->
        <script src="assets/lib/jquery-match-height/jquery.matchHeight-min.js"></script>
        <!-- scrollbar -->
        <script src="assets/lib/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>

        <!--加载页头-->
        <script src="assets/js/main_header.js"></script>

        <!-- Yukon Admin functions -->
        <script src="assets/js/yukon_all.js"></script>

        <!-- style switcher -->
        <div id="style_switcher">
            <a class="switcher_toggle"><i class="icon_cog"></i></a>
            <div class="style_items">
                <div class="heading_b"><span class="heading_text">Top Bar Color</span></div>
                <ul class="clearfix" id="topBar_style_switch">
                    <li class="sw_tb_style_0 style_active" title=""><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_1" title="topBar_style_1"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_2" title="topBar_style_2"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_3" title="topBar_style_3"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_4" title="topBar_style_4"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_5" title="topBar_style_5"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_6" title="topBar_style_6"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_7" title="topBar_style_7"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_8" title="topBar_style_8"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_9" title="topBar_style_9"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_10" title="topBar_style_10"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_11" title="topBar_style_11"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_12" title="topBar_style_12"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_13" title="topBar_style_13"><span class="icon_check_alt2"></span></li>
                    <li class="sw_tb_style_14" title="topBar_style_14"><span class="icon_check_alt2"></span></li>
                </ul>
            </div>
            <hr/>
            <div class="clearfix hidden-sm hidden-md hidden-xs sepH_b">
                <label>Fixed layout</label>
                <div class="pull-right"><input type="checkbox" id="fixed_layout_switch" class="js-switch mini-switch"></div>
            </div>
            <div class="style_items hidden-sm hidden-md hidden-xs" id="fixed_layout_bg_switch">
                <hr/>
                <div class="heading_b"><span class="heading_text">Background</span></div>
                <ul class="clearfix">
                    <li class="sw_bg_0" title="bg_0"></li>
                    <li class="sw_bg_1" title="bg_1"></li>
                    <li class="sw_bg_2" title="bg_2"></li>
                    <li class="sw_bg_3" title="bg_3"></li>
                    <li class="sw_bg_4" title="bg_4"></li>
                    <li class="sw_bg_5" title="bg_5"></li>
                    <li class="sw_bg_6" title="bg_6"></li>
                    <li class="sw_bg_7" title="bg_7"></li>
                </ul>
                <hr/>
            </div>
            <div class="clearfix sepH_b">
                <label>Top Menu</label>
                <div class="pull-right"><input type="checkbox" id="top_menu_switch" class="js-switch mini-switch"></div>
            </div>
            <div class="clearfix sepH_b">
                <label>Hide Breadcrumbs</label>
                <div class="pull-right"><input type="checkbox" id="breadcrumbs_hide" class="js-switch mini-switch"></div>
            </div>
            <div class="text-center sepH_a">
                <button data-toggle="modal" data-target="#showCSSModal" id="showCSS" class="btn btn-default btn-xs btn-outline" type="button">Show CSS</button>
            </div>
        </div>
        <div class="modal fade" id="showCSSModal">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="myModalLabel">CSS Classes</h4>
                    </div>
                    <div class="modal-body">
                        <pre id="showCSSPre"></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <script src="assets/js/uploadFile/ajaxfileupload.js"></script>
		<!-- JavaScript脚本程序 -->
		<script type="text/javascript">
		var result;
		var selectedArr = new Array();
		
		/**
		*维护数组函数 之 扩容 
		*/
		function addArray(id) {
			//增加一个元素，为数组扩容
			var len = selectedArr.length;
			selectedArr[len]=id;
		}
		
		/**
		*维护数组函数 之 缩容 
		*/
		function reduceArray(id){
			//减少一个元素,为数组缩容
			var middleware = new Array();
			var index = 0;
			for(var i=0; i<selectedArr.length; i++) {
				var one = selectedArr[i];
				if(one!=id) {
					middleware[index] = one;
					index++;
				}
			}
			selectedArr = middleware;
		}
		
		$(document).ready(function(){ 
			//查询联想的结果
			result = select();
			console.log(result.length);
			console.log(result[0].tag);
		});
		
		$("#association").bind('input porpertychange',function(){
			var value = $("#association").val();
			associateSearch(value);
		});
		
		function associateSearch(value) {
			//初始化
			var flag = false;
			$("#association-div").css('display','none');
			$("#association-div").css('border','1px solid #ccc');
			$("#association-div").empty();
			var ul = '<ul style="list-style-type:none;padding-left:3px;">';
			for(var i=0; i<result.length; i++) {
				if(result[i].tag.toLocaleUpperCase().indexOf(value.toLocaleUpperCase())>=0) {
					ul += '<li id="'+result[i].id+'"><a href="javascript:addTag(\''+result[i].id+'\',\''+result[i].tag+'\');">'+result[i].tag+'</a></li>';
					flag = true;
				}
			}
			ul += '</ul>';
			$("#association-div").append($(ul));
			if(!flag) {
				var btn = '<button class="btn-primary btn" type="button" onclick="insertTag()">添加</button>';
				$("#association-div").css('border','0');
				$("#association-div").css('display','block');
				$("#association-div").append($(btn));
			}
			if(flag) {
				$("#association-div").css('display','block');
				flag = false;
			}
		}
		
		/**
		* 新增标签
		*/
		function insertTag() {
			var tag = $("#association").val();
			var id = uuid();
			var li = '<li id="selected'+id+'"><a href="javascript:delTag(\''+id+'\');">'+tag+'<i class="icon_close_alt bs_ttip"></i></a></li>';
			$("#select_tags").append($(li));
			addArray("selected"+id);
		}
		
		/**
		* 添加标签
		*/
		function addTag(id,tag) {
			console.log(id);
			console.log(tag);
			var li = '<li id="selected'+id+'"><a href="javascript:delTag(\''+id+'\');">'+tag+'<i class="icon_close_alt bs_ttip"></i></a></li>';
			$("#select_tags").append($(li));
			addArray("selected"+id);
		}
		
		/**
		* 删除标签
		*/
		function delTag(id) {
			console.log(id);
			$("#selected"+id+"").remove();
			reduceArray("selected"+id);
		}
		
		function select() {
			//组装传输对象
			var loginInfoValue = new Object();
			var params = {
				action:'select-tag',
				data:""
			}; 
			var res;
			//AJAX请求	
			$.ajax({
				async:false, //禁止异步
				url : "/ddcomeNew/goodLuckToDd/back",
				type : "post",
				data : {
					params: JSON.stringify(params)
				},
				dataType : "json",
				success : function(json) {
					/*
					$("#message").html(json.message);
					//成功跳转
					if(json.status.toString() == '1'){
						 window.location.href="index.html";
					}
					*/
					console.log("成功 >>> ");
					console.log(json);
					res = json;
				},
				error : function(json) {
					/*
					alert(json.message);
					$("#message").html(json.message);
					*/
					console.log("失败");
					console.log(json);
					res = json;
				}
			});
			return res;
		}
		
		function insertArtTag() {
			var params = {
				action: 'insert-ArticlesTags',
				data: {}
			};
			console.log(JSON.stringify(params));
			$.ajax({
				async:false, //禁止异步
				url : "/ddcomeNew/goodLuckToDd/back",
				type : "post",
				data : {
					params: JSON.stringify(params)
				},
				dataType : "json",
				success : function(json) {
					/*
					$("#message").html(json.message);
					//成功跳转
					if(json.status.toString() == '1'){
						 window.location.href="index.html";
					}
					*/
					console.log("成功 >>> ");
					console.log(json);
					
				},
				error : function(json) {
					/*
					alert(json.message);
					$("#message").html(json.message);
					*/
					console.log("失败");
					console.log(json);
				}
			});
		}
		
		/**
		* 执行上传操作，上传文件是一个流程，流程如下：
		* 1.先处理tags数据到tags表 
		* 2.处理pdf文件信息到articles表 
		* 3.增加关联数据到articles_tags表 
		* 4.恢复sign值,update操作
		*/
		function upload() {
			//1.获取文本信息，先处理文本信息
			console.log(selectedArr);
			var arr = new Array();
			var arrNew = new Array();
			var index = 0;
			var indexNew = 0;
			for(var i=0; i<selectedArr.length; i++) {
				//对于新增的数据和选中历史tags数据作区分
				if(selectedArr[i].indexOf("_")>0) {
					arrNew[indexNew] = $("#"+selectedArr[i]+" a").text();
					indexNew++;
				} else {
					arr[index] = $("#"+selectedArr[i]+" a").text();
					index++;
				}
			}
			//获取input框中的服务器上传路径值
			var serverUrl = $("#serverUrl").val();
			var dataValue = {
				tags: {
					oldTags: arr,
					newTags: arrNew
				},
				path: serverUrl
			};
			var params = {
				action: 'insert-tag',
				data: {
					tags: {
						oldTags: arr,
						newTags: arrNew
					},
					path: serverUrl
					}
			};
			console.log(JSON.stringify(params));
			$.ajax({
				async:false, //禁止异步
				url : "/ddcomeNew/goodLuckToDd/back",
				type : "post",
				data : {
					params: JSON.stringify(params)
				},
				dataType : "json",
				success : function(json) {
					/*
					$("#message").html(json.message);
					//成功跳转
					if(json.status.toString() == '1'){
						 window.location.href="index.html";
					}
					*/
					console.log("成功 >>> ");
					console.log(json);
					ajaxFileUpload();//上传文件
				},
				error : function(json) {
					/*
					alert(json.message);
					$("#message").html(json.message);
					*/
					console.log("失败");
					console.log(json);
				}
			});
		}
		
		/**
		* 页面初始化
		*/
		$(function(){
			//查询联想的结果
			console.log("开始执行 ");
		});
		
	    //测试
	    function ajaxFileUpload() {
	    	var serverUrl = $("#serverUrl").val();
	    
	    	
			$.ajaxFileUpload({
				url : '/ddcomeNew/goodLuckToDd/upload-file',
				secureuri : false,
				fileElementId : 'fileToUpload',
				dataType : 'JSON',
				data : {},
				success : function(data, status) {
					console.log(data);
					console.log(status);
					//$('#viewImg').attr('src',data.picUrl);
					insertArtTag();
				},
				error : function(data, status, e) {
					console.log(data);
					console.log(status);
					console.log(e);
					alert('上传出错');
				}
			})
			return false;
		}
	    
	    function uuid() {
	        var s = [];
	        var hexDigits = "0123456789abcdef";
	        for (var i = 0; i < 36; i++) {
	            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
	        }
	        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
	        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
	        s[8] = s[13] = s[18] = s[23] = "_";
	     
	        var uuid = s.join("");
	        return uuid;
	    }      
		
		</script>
		
    </body>

</html>
